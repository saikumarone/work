HOST="your-hostname-or-user@hostname"; DB="postgres"; mkdir -p "$HOST"; for f in /sql_scripts/*.sql; do b="$(basename "$f" .sql)"; { echo "=========== $b ==========="; ssh -o BatchMode=yes "$HOST" "sudo -u postgres -i psql -v ON_ERROR_STOP=1 -d \"$DB\" -f -" < "$f"; } > "$HOST/$b.log" 2>&1; done





HOST="user@remotehost"; DB="postgres"; shopt -s nullglob; mkdir -p "$HOST"; \
INCLUDE_SCHEMAS="$(ssh -o BatchMode=yes "$HOST" "sudo -u postgres -i psql -At -d \"$DB\" -c \"SELECT COALESCE(string_agg(quote_literal(nspname), ','), '') FROM pg_namespace WHERE nspname NOT IN ('pg_catalog','information_schema') AND nspname NOT LIKE 'pg_toast%' AND nspname NOT LIKE 'pg_temp%';\"")"; \
[ -z "$INCLUDE_SCHEMAS" ] && INCLUDE_SCHEMAS="'public'"; \
for f in /sql_scripts/*.sql; do b="$(basename "$f" .sql)"; { \
  echo "=========== $b ==========="; \
  { printf "\\set include_schemas %s\n" "$INCLUDE_SCHEMAS"; cat "$f"; } | \
  ssh -o BatchMode=yes "$HOST" "sudo -u postgres -i psql -v ON_ERROR_STOP=1 -d \"$DB\" -f -"; \
} > "$HOST/$b.log" 2>&1; done






HOST="user@remotehost"; DB="postgres"; shopt -s nullglob; mkdir -p "$HOST"; \
INCLUDE_SCHEMAS_RAW="$(ssh -o BatchMode=yes "$HOST" "sudo -u postgres -i psql -At -d \"$DB\" -c \"SELECT COALESCE(string_agg(quote_literal(nspname), ','), '') FROM pg_namespace WHERE nspname NOT IN ('pg_catalog','information_schema') AND nspname NOT LIKE 'pg_toast%%' AND nspname NOT LIKE 'pg_temp%%';\"")"; \
[ -z "$INCLUDE_SCHEMAS_RAW" ] && INCLUDE_SCHEMAS_RAW="'public'"; \
INCLUDE_SCHEMAS_ESCAPED="$(printf "%s" "$INCLUDE_SCHEMAS_RAW" | sed "s/'/''/g")"; \
for f in /sql_scripts/*.sql; do b="$(basename "$f" .sql)"; { \
  echo "=========== $b ==========="; \
  { printf "\\set include_schemas '%s'\n" "$INCLUDE_SCHEMAS_ESCAPED"; cat "$f"; } | \
  ssh -o BatchMode=yes "$HOST" "sudo -u postgres -i psql -v ON_ERROR_STOP=1 -d \"$DB\" -f -"; \
} > "$HOST/$b.log" 2>&1; done



Check constraint
-----------------
WITH relevant_schemas AS (
  SELECT n.oid AS namespace_oid, n.nspname
  FROM pg_namespace n
  WHERE n.nspname IN ('audit','public')  -- put your schemas here
)
SELECT
  concat_ws(
    '.',
    s.nspname::text,
    coalesce(rel.relname::text, '?'),
    con.contype::text,
    con.conname::text
  ) AS check_cons
FROM pg_constraint con
JOIN relevant_schemas s ON s.namespace_oid = con.connamespace
LEFT JOIN pg_class rel ON rel.oid = con.conrelid
WHERE con.contype = 'c'
ORDER BY 1;


research.quote_snap 
market_builder_2.volatility_surface
market_builder_2.bond_market_built_btt
market_data.snap
risk.riskbeta_reports
research.daily                     
_timescaledb_internal._compressed_hypertable_16 
ticks.trade                     
research.quote_snap_credit         
research.credit_vol                
xccy.ubs_stir_analytics        


+ host_dir=outputs/gcpapp29lhc
+ mkdir -p outputs/gcpapp29lhc
+ ssh -p 22 -o BatchMode=yes -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -o StrictHostKeyChecking=accept-new -o ControlMaster=auto -o ControlPersist=60s -o ServerAliveInterval=30 -o ServerAliveCountMax=4 sadepollutp_gcp@gcpapp29lhc 'sudo -u postgres bash -lc '\''DB_NAME="$DB_NAME" EXCLUDE_LIST="$EXCLUDE_LIST" bash -s'\''' DB_NAME=gcppsg1 'EXCLUDE_LIST=research.quote_snap
market_builder_2.volatility_surface
market_builder_2.bond_market_built_btt
market_data.snap
risk.riskbeta_reports
research.daily
_timescaledb_internal._compressed_hypertable_16
ticks.trade
research.quote_snap_credit
research.credit_vol
xccy.ubs_stir_analytics'
+ tee outputs/gcpapp29lhc/counts.txt
bash: line 18: t: unbound variable
bash: line 2: market_builder_2.volatility_surface: command not found
bash: line 3: market_builder_2.bond_market_built_btt: command not found
bash: line 4: market_data.snap: command not found
bash: line 5: risk.riskbeta_reports: command not found
bash: line 6: research.daily: command not found
bash: line 7: _timescaledb_internal._compressed_hypertable_16: command not found
bash: line 8: ticks.trade: command not found
bash: line 9: research.quote_snap_credit: command not found
bash: line 10: research.credit_vol: command not found
bash: line 11: xccy.ubs_stir_analytics: command not found
+ echo 'ERROR: Remote execution failed on gcpapp29lhc'
ERROR: Remote execution failed on gcpapp29lhc
+ exit 1



SELECT table_schema || '.' || table_name AS full_table_name
FROM information_schema.tables
WHERE table_type = 'BASE TABLE'
  AND table_schema NOT IN ('pg_catalog', 'information_schema', 'pg_toast', 'pglogical')
  AND (table_schema || '.' || table_name) NOT IN (
      'public.audit_log',
      'public.temp_data',
      'market_data.snap'
  )
ORDER BY table_schema, table_name;


